<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />

<script type="text/javascript" src="http://cdn.robotwebtools.org/EventEmitter2/current/eventemitter2.min.js"></script>
<script type="text/javascript" src="http://cdn.robotwebtools.org/roslibjs/current/roslib.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

<script type="text/javascript" type="text/javascript">
  // Connecting to ROS
  // -----------------

  var ros = new ROSLIB.Ros({
    url : 'ws://localhost:9090'
  });

  var IpList = new ROSLIB.Param({
    ros : ros,
    name : '/IP'
  });
  
  	IpList.get(function(value) {
  		var select = document.getElementById("deviceList");
  		$.each( value, function( key, value ) {
  		   select.options[select.options.length] = new Option(key, value);
		});
  });
  
  function camera(deviceName,ip,deviceParam,timelapsObj){
      this.deviceName = deviceName;
      this.ip = ip;
      this.deviceParam = deviceParam;
      this.timelapsObj = timelapsObj;
  };
  function timelapsContainer(client){
    this.client = client;
    this.statusMessage = 'Idle'
    this.feedbackMessage = ''
    this.terminationMessage = '' 
  };
  
  var cameraArray = [];
  var currentDevice;
  
  function printTimelaps(camera){
    if(camera === null){
      document.getElementById("dd_Device").textContent = '';
      document.getElementById("dd_IP").textContent = '';
      document.getElementById("dd_Camera").textContent = ''; 
      document.getElementById("dd_timelaps_termination").textContent =  '';
      document.getElementById("dd_timelaps_status").textContent = '';
      document.getElementById("dd_timelaps_feedback").textContent = '';
    }
    else{
      document.getElementById("dd_Device").textContent = camera.deviceName;
      document.getElementById("dd_IP").textContent = camera.ip;
      camera.deviceParam.get(function(value){
        if(value != null && value["camera_model"] != null){
          document.getElementById("dd_Camera").textContent = value["camera_model"];
        }
        else{
          document.getElementById("dd_Camera").textContent = 'Camera Not Connected';
        }
                      });
      document.getElementById("dd_timelaps_termination").textContent =  camera.timelapsObj.terminationMessage;
      document.getElementById("dd_timelaps_status").textContent = camera.timelapsObj.statusMessage;
      document.getElementById("dd_timelaps_feedback").textContent = camera.timelapsObj.feedbackMessage;
    }
  }
  
  
  function selectEvent(select){
    if(select.selectedIndex == 0){
      printTimelaps(null);
    }
    else{
      currentDevice = select.options[select.selectedIndex].text;
      var deviceParam =  new ROSLIB.Param({
        ros : ros,
        name : '/'+currentDevice
      }); 
      var timelapsClient = new ROSLIB.ActionClient({
        ros : ros,
        serverName : currentDevice + '/timelaps',
        actionName : 'camera_network_msgs/CameraControlAction'  
      });  
  
      var device;
      var found = false;
      device = getDevice(currentDevice)
      if(device == null){
        device = new camera(currentDevice,select.value,deviceParam,new timelapsContainer(timelapsClient,''));
        cameraArray.push(device);            
      }
      printTimelaps(device);
      
    }
  }
  
  function getDevice(deviceName){
    for(var i = 0; i < cameraArray.length;i++){
      if(cameraArray[i].deviceName == deviceName){
        return cameraArray[i];      
      }  
    }
    return null;
  }
  
  
  function publishShot(){
    var cmdShot = new ROSLIB.Topic({
      ros : ros,
      name : '/network_capture_chatter',
      messageType : 'camera_network_msgs/Capture'
    });
    var capture = new ROSLIB.Message({
      isHdr : false
    });
    
    cmdShot.publish(capture);
  }
  
  

  function timelapsAction(form){
    camera = getDevice(currentDevice);
    var goal = new ROSLIB.Goal({
    actionClient : camera.timelapsObj.client,
    goalMessage : {
      picture_qty : parseFloat(form.timelaps_qty.value),
      inter_picture_delay_s : parseFloat(form.timelaps_frequency.value)
    }
  });
  
    goal.on('feedback', function(feedback) {
      camera.timelapsObj.feedbackMessage = feedback.picture_taken
      printTimelaps(getDevice(currentDevice))
    });
    goal.on('result', function(result) {
      camera.timelapsObj.statusMessage = "Idle";
      camera.timelapsObj.terminationMessage =  result.total_picture;
      printTimelaps(getDevice(currentDevice))
    });
    goal.send();
    camera.timelapsObj['goal'] = goal;
    camera.timelapsObj.statusMessage = "Taking " + form.timelaps_qty.value + " Pictures at a frequency of " + form.timelaps_frequency.value;
    camera.timelapsObj.feedbackMessage = "Waiting for feedback"
    printTimelaps(getDevice(currentDevice))
  }  
  
  
  
  var downloadClient = new ROSLIB.ActionClient({
    ros : ros,
    serverName : 'master/sftp',
    actionName : 'camera_network_msgs/CameraDownloadAction'
  });  
  
  function downloadAction(form){
    var goal = new ROSLIB.Goal({
    actionClient : downloadClient,
    goalMessage : {
      dowload_frequency_s : parseFloat(form.frequency.value)
    }
  });
    goal.on('feedback', function(feedback) {
      document.getElementById("dd_download_feedback").textContent = feedback.picture_downloaded
    });
    goal.on('result', function(result) {
      document.getElementById("dd_download_status").textContent = "Idle";
      document.getElementById("dd_download_termination").textContent = result.total_downloaded;
    });
    goal.send();
    document.getElementById("dd_download_status").textContent = "Downloading every " + form.frequency.value + " s";
    document.getElementById("dd_download_feedback").textContent = "Waiting for feedback"
  }  

  
</script>
<link rel="stylesheet" href="style.css" type="text/css" media="screen, projection" />
</head>

<body>
  <header>
    <h1>Camera Network</h1>
  </header>
  
<nav class="mainStyle">
  <select class = "styleSelect" onchange="selectEvent(this);" id ="deviceList">
    <option value="index0">Online Devices</option>
  </select> 
  <dl>
    <dt>Device:</dt>
      <dd id="dd_Device"></dd>
    <dt>IP:</dt>
      <dd id="dd_IP"></dd>
    <dt>Camera Type:</dt>
      <dd id="dd_Camera"></dd>
  </dl> 

    
  <!-- Timelaps interface -->
  <div class="timelapsStyle">
    <form name="timelaps" action="javascript:void(0)" method="get">
        Frequency (s) : <input id="timelaps_frequency" type="number" value=0 name="timelaps_frequency" >
        Quantity (<0 = infinite) : <input id="timelaps_quantity" type="number" value=0 name="timelaps_qty" >
      <dl>
        <dt>Status:</dt>
          <dd id ="dd_timelaps_status">Idle</dd>
        <dt>Feedback:</dt>
          <dd id="dd_timelaps_feedback"></dd>
        <dt>Termination:</dt>
          <dd id="dd_timelaps_termination"></dd>
      </dl>
      <input type="submit" class="styleButton" onclick="timelapsAction(this.form)" value="Set">
    </form> 
  </div>
</nav> 
  
  <!-- Network shot Button -->
  <button type="button" class="styleButton" onclick = "publishShot()">Network Shot!</button> 

  <!-- Download interface -->
  <div class="mainStyle">
    <form name="download" action="javascript:void(0)" method="get">
      Download frequency (s) (0 = one time) : <input id="input_frequency" type="number" value=0 name="frequency" >
      <dl>
        <dt>Status:</dt>
          <dd id ="dd_download_status">Idle</dd>
        <dt>Feedback:</dt>
          <dd id="dd_download_feedback"></dd>
        <dt>Termination:</dt>
          <dd id="dd_download_termination"></dd>
      </dl>
      <input type="submit" class="styleButton" onclick="downloadAction(this.form)" value="Download">
    </form> 
  </div>
  
</body>
</html>